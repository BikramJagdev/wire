language: go
dist: xenial
sudo: false
services:
  - docker
env:
  matrix:
    - GO111MODULE=on
matrix:
  allow_failures:
  include:
    - os: linux
      go: 1.12.x
      cache:
        directories:
          - "/home/travis/.cache/go-build"
    - os: osx
      go: 1.12.x
      cache:
        directories:
          - "/Users/travis/Library/Caches/go-build"
  # - os: windows
  #   go: 1.12.x
before_install:
  - GO111MODULE=off go get -u github.com/client9/misspell/cmd/misspell
  - GO111MODULE=off go get -u golang.org/x/lint/golint
  - GO111MODULE=off go get github.com/fzipp/gocyclo
  - GO111MODULE=off go get -u honnef.co/go/tools/cmd/staticcheck
  - GO111MODULE=off go get golang.org/x/tools/cmd/cover
before_script:
  - GOFILES=$(find . -type f -name '*.go' | grep -v client)
script:
  # Just check gofmt on linux, it's the fastest builder
  - if [[ "$TRAVIS_OS_NAME" == "linux" ]]; then test -z $(gofmt -s -l $GOFILES); fi
  - go test ./... -race -coverprofile=coverage.txt -covermode=atomic
  - misspell -error -locale US $GOFILES
  #- gocyclo -over $GOFILES
  - golint -set_exit_status $GOFILES
  - staticcheck ./cmd/*/*.go *.go # TODO(brooke): later add ./pkg/*/*.go
  - if [[ "$TRAVIS_OS_NAME" == "windows" ]]; then choco install -y mingw; export PATH=/c/tools/mingw64/bin:"$PATH";fi
after_success:
  - bash <(curl -s https://codecov.io/bash)
  - make
  - make client
  - make docker
before_deploy:
  - make dist
after_deploy:
  - echo "$DOCKER_PASSWORD" | docker login -u "$DOCKER_USERNAME" --password-stdin
  - make release-push
deploy:
  provider: releases
  api_key:
    secure: Qhweoc+1/wLjbq6uNUHti8ZSaFFhuYTrGLaUKVR/QMNJtIbIuEjIXYhPYdKOl67vId2SDjTYW9tsAEpYReWmpzRZ33uVke/G1tXovrGVZFiIxgytndDKintJzC1LKMWdy0k9X9CVIg5e1jd7DiJOKauwM4/y4quJiTgy1z66rkrYH/HIM3h47gDno74y7/8OSpgNcdYr5iashwWdT7eWE5Dn1Fr8v6+/ClLQpbxczB0la8cU3zQl+o8qvZ3Y5lNEBOcCV7FtFpXhFnYEDGtVpZBIUXFJLIRCj4+HQ0DqZ+wC4RGb7lSkRLvTqhpIPn2a4gIOkKXeS3J9dgBYXHkWYF+wLUmbtqgWW7a6jK2n1G8MFNrbQiLi+AgIcbop8h96Q1W8ueBYj7cMXlKKlWAX5PGt2zryvD4DR3P/iFhC6h1jf/ISVVl2BJUbLSCmzv+qR8Y41ptzWUR2lC3lR2/OCbEpgnU5AiZfPhJNrooKm4fHxTGH23d6HCWDw1NthYUMBkn22Jkf3pEZYQsGXj7Q00jgQ6WfAlbb7SHWgbxVb+fSgkU0tWtWInf76VZhROfdCqtvmkqJV3ThLi0RRzXi7CHilx9mL05ISkaDmoJWULDgUb5qdrIvg8Bhi/5EDWQ8sEDJEN239F7go1I6HPtD6P9BYXgS09tu8cidzF4mtyw=
  file_glob: true
  file:
    - bin/wire-*
  on:
    repo: moov-io/wire
    tags: true
    go: 1.12.x
  skip_cleanup: true
